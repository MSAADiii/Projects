(()=>{var f=class{constructor(e){$.extend(this,e),this.fieldinfo={},this.doctype=this.df.options,this.doctype&&(this.meta=frappe.get_meta(this.doctype)),this.fields_map={},this.template=null,this.multiple_set=!1,this.frm&&this.frm.meta.__form_grid_templates&&this.frm.meta.__form_grid_templates[this.df.fieldname]&&(this.template=this.frm.meta.__form_grid_templates[this.df.fieldname]),this.is_grid=!0,this.debounced_refresh=this.refresh.bind(this),this.debounced_refresh=frappe.utils.debounce(this.debounced_refresh,100)}allow_on_grid_editing(){return frappe.utils.is_xs()?!1:!!(this.meta&&this.meta.editable_grid||!this.meta)}make(){let e=`
			<label class="control-label">${__(this.df.label||"")}</label>
			<p class="text-muted small grid-description"></p>
			<div class="grid-custom-buttons grid-field"></div>
			<div class="form-grid">
				<div class="grid-heading-row"></div>
				<div class="grid-body">
					<div class="rows"></div>
					<div class="grid-empty text-center">
						<img
							src="/assets/frappe/images/ui-states/grid-empty-state.svg"
							alt="Grid Empty State"
							class="grid-empty-illustration"
						>
						${__("No Data")}
					</div>
				</div>
			</div>
			<div class="small form-clickable-section grid-footer">
				<div class="flex justify-between">
					<div class="grid-buttons">
						<button class="btn btn-xs btn-danger grid-remove-rows hidden"
							style="margin-right: 4px;"
							data-action="delete_rows">
							${__("Delete")}
						</button>
						<button class="btn btn-xs btn-danger grid-remove-all-rows hidden"
							style="margin-right: 4px;"
							data-action="delete_all_rows">
							${__("Delete All")}
						</button>
						<button class="grid-add-multiple-rows btn btn-xs btn-secondary hidden"
							style="margin-right: 4px;">
							${__("Add Multiple")}</a>
						</button>
						<!-- hack to allow firefox include this in tabs -->
						<button class="btn btn-xs btn-secondary grid-add-row">
							${__("Add Row")}
						</button>
					</div>
					<div class="grid-pagination">
					</div>
					<div class="text-right">
						<a href="#" class="grid-download btn btn-xs btn-secondary hidden">
							${__("Download")}
						</a>
						<a href="#" class="grid-upload btn btn-xs btn-secondary hidden">
							${__("Upload")}
						</a>
					</div>
				</div>
			</div>
		`;this.wrapper=$(e).appendTo(this.parent),$(this.parent).addClass("form-group"),this.set_grid_description(),frappe.utils.bind_actions_with_object(this.wrapper,this),this.form_grid=this.wrapper.find(".form-grid"),this.setup_add_row(),this.setup_grid_pagination(),this.custom_buttons={},this.grid_buttons=this.wrapper.find(".grid-buttons"),this.grid_custom_buttons=this.wrapper.find(".grid-custom-buttons"),this.remove_rows_button=this.grid_buttons.find(".grid-remove-rows"),this.remove_all_rows_button=this.grid_buttons.find(".grid-remove-all-rows"),this.setup_allow_bulk_edit(),this.setup_check(),this.df.on_setup&&this.df.on_setup(this)}set_grid_description(){let e=$(this.parent).find(".grid-description");this.df.description?e.text(__(this.df.description)):e.hide()}setup_grid_pagination(){this.grid_pagination=new GridPagination({grid:this,wrapper:this.wrapper})}setup_check(){this.wrapper.on("click",".grid-row-check",e=>{var t=$(e.currentTarget);if(t.parents(".grid-heading-row:first").length!==0){var i=t.prop("checked");t.parents(".form-grid:first").find(".grid-row-check").prop("checked",i);let a=this.grid_pagination.get_result_length(),d=this.grid_pagination.page_index,o=this.grid_pagination.page_length;for(var s=(d-1)*o;s<a;s++)this.grid_rows[s].doc.__checked=i?1:0}else{var r=t.parents(".grid-row:first").attr("data-name");this.grid_rows_by_docname[r].select(t.prop("checked"))}this.refresh_remove_rows_button()})}delete_rows(){var e=!1;let t=[],i=this.get_selected_children();i.forEach(s=>{t.push(()=>{this.frm||(this.df.data=this.get_data(),this.df.data=this.df.data.filter(r=>r.idx!=s.idx)),this.grid_rows_by_docname[s.name].remove(),e=!0}),t.push(()=>frappe.timeout(.1))}),this.frm||t.push(()=>{this.df.data.forEach((s,r)=>s.idx=r+1)}),t.push(()=>{e&&(this.refresh(),this.frm&&this.frm.script_manager.trigger(this.df.fieldname+"_delete",this.doctype))}),frappe.run_serially(t),this.wrapper.find(".grid-heading-row .grid-row-check:checked:first").prop("checked",0),i.length==this.grid_pagination.page_length&&this.scroll_to_top()}delete_all_rows(){frappe.confirm(__("Are you sure you want to delete all rows?"),()=>{this.frm.doc[this.df.fieldname]=[],$(this.parent).find(".rows").empty(),this.grid_rows=[],this.refresh(),this.frm&&this.frm.script_manager.trigger(this.df.fieldname+"_delete",this.doctype),this.frm&&this.frm.dirty(),this.scroll_to_top()})}scroll_to_top(){frappe.utils.scroll_to(this.wrapper)}select_row(e){this.grid_rows_by_docname[e].select()}remove_all(){this.grid_rows.forEach(e=>{e.remove()})}refresh_remove_rows_button(){if(this.df.cannot_delete_rows)return;this.remove_rows_button.toggleClass("hidden",!this.wrapper.find(".grid-body .grid-row-check:checked:first").length);let t=this.wrapper.find(".grid-heading-row .grid-row-check:checked:first").length&&this.data.length>this.get_selected_children().length;this.remove_all_rows_button.toggleClass("hidden",!t)}get_selected(){return(this.grid_rows||[]).map(e=>e.doc.__checked?e.doc.name:null).filter(e=>e)}get_selected_children(){return(this.grid_rows||[]).map(e=>e.doc.__checked?e.doc:null).filter(e=>e)}reset_grid(){this.visible_columns=[],this.grid_rows=[],$(this.parent).find(".grid-body .grid-row").remove(),this.refresh()}make_head(){this.header_row&&$(this.parent).find(".grid-heading-row .grid-row").remove(),this.header_row=new GridRow({parent:$(this.parent).find(".grid-heading-row"),parent_df:this.df,docfields:this.docfields,frm:this.frm,grid:this,configure_columns:!0})}refresh(e){if(this.frm&&this.frm.setting_dependency)return;this.data=this.get_data(),!this.wrapper&&this.make();let t=$(this.parent).find(".rows");this.setup_fields(),this.frm?this.display_status=frappe.perm.get_field_display_status(this.df,this.frm.doc,this.perm):this.df.is_web_form&&this.control?this.display_status=this.control.get_status():this.display_status="Write",this.display_status!=="None"&&(this.make_head(),this.grid_rows||(this.grid_rows=[]),this.truncate_rows(),this.grid_rows_by_docname={},this.grid_pagination.update_page_numbers(),this.render_result_rows(t,!1),this.grid_pagination.check_page_number(),this.wrapper.find(".grid-empty").toggleClass("hidden",Boolean(this.data.length)),this.setup_toolbar(),this.toggle_checkboxes(this.display_status!=="Read"),this.frm&&this.is_sortable()&&!this.sortable_setup_done&&(this.make_sortable(t),this.sortable_setup_done=!0),this.last_display_status=this.display_status,this.last_docname=this.frm&&this.frm.docname,this.form_grid.toggleClass("error",!!(this.df.reqd&&!(this.data&&this.data.length))),this.refresh_remove_rows_button(),this.wrapper.trigger("change"))}render_result_rows(e,t){let i=this.grid_pagination.get_result_length(),s=this.grid_pagination.page_index,r=this.grid_pagination.page_length;if(!!this.grid_rows)for(var a=(s-1)*r;a<i;a++){var d=this.data[a];if(!d)return;if(d.idx===void 0&&(d.idx=a+1),d.name===void 0&&(d.name="row "+d.idx),this.grid_rows[a]&&!t){var o=this.grid_rows[a];o.doc=d,o.refresh()}else{var o=new GridRow({parent:e,parent_df:this.df,docfields:this.docfields,doc:d,frm:this.frm,grid:this});this.grid_rows[a]=o}this.grid_rows_by_docname[d.name]=o}}setup_toolbar(){this.is_editable()?(this.wrapper.find(".grid-footer").toggle(!0),this.cannot_add_rows||this.df&&this.df.cannot_add_rows?this.wrapper.find(".grid-add-row, .grid-add-multiple-rows").addClass("hidden"):(this.wrapper.find(".grid-add-row").removeClass("hidden"),this.multiple_set&&this.wrapper.find(".grid-add-multiple-rows").removeClass("hidden"))):this.grid_rows.length<this.grid_pagination.page_length&&this.wrapper.find(".grid-footer").toggle(!1),this.wrapper.find(".grid-add-row, .grid-add-multiple-rows").toggle(this.is_editable())}truncate_rows(){if(this.grid_rows.length>this.data.length){for(var e=this.data.length;e<this.grid_rows.length;e++){var t=this.grid_rows[e];t&&t.wrapper.remove()}this.grid_rows.splice(this.data.length)}}setup_fields(){this.frm&&this.frm.docname?this.df=frappe.meta.get_docfield(this.frm.doctype,this.df.fieldname,this.frm.docname):this.df.options&&(this.df=frappe.meta.get_docfield(this.df.options,this.df.fieldname)||this.df||null),this.doctype&&this.frm?this.docfields=frappe.meta.get_docfields(this.doctype,this.frm.docname):this.docfields=this.df.fields,this.docfields.forEach(e=>{this.fields_map[e.fieldname]=e})}refresh_row(e){this.grid_rows_by_docname[e]&&this.grid_rows_by_docname[e].refresh()}make_sortable(e){new Sortable(e.get(0),{group:{name:this.df.fieldname},handle:".sortable-handle",draggable:".grid-row",animation:100,filter:"li, a",onMove:t=>{if(!this.is_editable())return!1;let i=$(t.dragged).closest(".grid-row").attr("data-idx"),s=this.data[i%this.grid_pagination.page_length];if(s&&s._sortable===!1)return!1},onUpdate:t=>{let i=$(t.item).closest(".grid-row").attr("data-idx")-1,s=this.data[i%this.grid_pagination.page_length];this.renumber_based_on_dom(),this.frm.script_manager.trigger(this.df.fieldname+"_move",this.df.options,s.name),this.refresh(),this.frm.dirty()}}),$(this.frm.wrapper).trigger("grid-make-sortable",[this.frm])}get_data(){var e=this.frm?this.frm.doc[this.df.fieldname]||[]:this.df.data||this.get_modal_data();return e}get_modal_data(){return this.df.get_data?this.df.get_data().filter(e=>{if(!this.deleted_docs||!in_list(this.deleted_docs,e.name))return e}):[]}set_column_disp(e,t){if($.isArray(e))for(var i=0,s=e.length;i<s;i++){var r=e[i];this.get_docfield(r).hidden=t?0:1,this.set_editable_grid_column_disp(r,t)}else this.get_docfield(e).hidden=t?0:1,this.set_editable_grid_column_disp(e,t);this.debounced_refresh()}set_editable_grid_column_disp(e,t){this.meta.editable_grid&&this.grid_rows&&this.grid_rows.forEach(i=>{i.columns_list.forEach(s=>{s.df.fieldname==e&&(t?(s.df.hidden=!1,i!=frappe.ui.form.editable_row?(s.static_area.show(),s.field_area&&s.field_area.toggle(!1)):(s.static_area.hide(),s.field_area&&s.field_area.toggle(!0),s.field&&(s.field.refresh(),s.field.$input&&s.field.$input.toggleClass("input-sm",!0)))):(s.df.hidden=!0,s.static_area.hide()))})}),this.refresh()}toggle_reqd(e,t){this.get_docfield(e).reqd=t,this.debounced_refresh()}toggle_enable(e,t){this.get_docfield(e).read_only=t?0:1,this.debounced_refresh()}toggle_display(e,t){this.get_docfield(e).hidden=t?0:1,this.debounced_refresh()}toggle_checkboxes(e){this.wrapper.find(".grid-row-check").prop("disabled",!e)}get_docfield(e){return frappe.meta.get_docfield(this.doctype,e,this.frm?this.frm.docname:null)}get_row(e){return typeof e=="number"?e<0?this.grid_rows[this.grid_rows.length+e]:this.grid_rows[e]:this.grid_rows_by_docname[e]}get_grid_row(e){return this.get_row(e)}get_field(e){return this.fieldinfo[e]||(this.fieldinfo[e]={}),this.fieldinfo[e]}set_value(e,t,i){this.display_status!=="None"&&this.grid_rows_by_docname[i.name]&&this.grid_rows_by_docname[i.name].refresh_field(e,t)}setup_add_row(){this.wrapper.find(".grid-add-row").click(()=>(this.add_new_row(null,null,!0,null,!0),this.set_focus_on_row(),!1))}add_new_row(e,t,i,s,r=!1){if(this.is_editable()){if(r&&this.grid_pagination.go_to_last_page_to_add_row(),this.frm){var a=frappe.model.add_child(this.frm.doc,this.df.options,this.df.fieldname,e);s&&(a=this.duplicate_row(a,s)),a.__unedited=!0,this.frm.script_manager.trigger(this.df.fieldname+"_add",a.doctype,a.name),this.refresh()}else this.df.data||(this.df.data=this.get_data()||[]),this.df.data.push({idx:this.df.data.length+1,__islocal:!0}),this.refresh();return i&&(e?this.wrapper.find("[data-idx='"+e+"']").data("grid_row").toggle_view(!0,t):this.allow_on_grid_editing()||this.wrapper.find(".grid-row:last").data("grid_row").toggle_view(!0,t)),a}}renumber_based_on_dom(){$(this.parent).find(".rows").find(".grid-row").each((t,i)=>{let s=$(i),r=(this.grid_pagination.page_index-1)*this.grid_pagination.page_length+t,a=locals[this.doctype][s.attr("data-name")];a.idx=r+1,s.attr("data-idx",a.idx),this.frm.doc[this.df.fieldname][r]=a,this.data[r]=a,this.grid_rows[r]=this.grid_rows_by_docname[a.name]})}duplicate_row(e,t){return $.each(t,function(i,s){["creation","modified","modified_by","idx","owner","parent","doctype","name","parentfield"].includes(i)||(e[i]=s)}),e}set_focus_on_row(e){e||(e=this.grid_rows.length-1),setTimeout(()=>{this.grid_rows[e].row.find('input[type="Text"],textarea,select').filter(":visible:first").focus()},100)}setup_visible_columns(){if(!(this.visible_columns&&this.visible_columns.length>0)){this.user_defined_columns=[],this.setup_user_defined_columns();var e=1,t=this.user_defined_columns&&this.user_defined_columns.length>0?this.user_defined_columns:this.editable_fields||this.docfields;this.visible_columns=[];for(var i in t){var s=t[i];if(d=this.user_defined_columns&&this.user_defined_columns.length>0?s:this.fields_map[s.fieldname],d&&!d.hidden&&(this.editable_fields||d.in_list_view)&&(this.frm&&this.frm.get_perm(d.permlevel,"read")||!this.frm)&&!in_list(frappe.model.layout_fields,d.fieldtype)){if(d.columns?d.colsize=d.columns:this.update_default_colsize(d),d.fieldtype=="Link"&&!d.formatter&&d.parent&&frappe.meta.docfield_map[d.parent]){let l=frappe.meta.docfield_map[d.parent][d.fieldname];l&&l.formatter&&(d.formatter=l.formatter)}if(e+=d.colsize,e>1100)return!1;this.visible_columns.push([d,d.colsize])}}for(var r=0;e<11&&r<12;){for(var a in this.visible_columns){var d=this.visible_columns[a][0],o=this.visible_columns[a][1];if(o>1&&o<11&&!in_list(frappe.model.std_fields_list,d.fieldname)){if(r<3&&["Int","Currency","Float","Check","Percent"].indexOf(d.fieldtype)!==-1)continue;this.visible_columns[a][1]+=1,e++}if(e>1e3)break}r++}}}update_default_colsize(e){var t=2;switch(e.fieldtype){case"Text":break;case"Small Text":t=3;break;case"Check":t=1}e.colsize=t}setup_user_defined_columns(){if(this.frm){let e=frappe.get_user_settings(this.frm.doctype,"GridView");e&&e[this.doctype]&&e[this.doctype].length&&(this.user_defined_columns=e[this.doctype].map(t=>{let i=frappe.meta.get_docfield(this.doctype,t.fieldname);if(i)return i.in_list_view=1,i.columns=t.columns,i}))}}is_editable(){return this.display_status=="Write"&&!this.static_rows}is_sortable(){return this.sortable_status||this.is_editable()}only_sortable(e){(e===void 0||e)&&(this.sortable_status=!0,this.static_rows=!0)}set_multiple_add(e,t){if(!this.multiple_set){var i=frappe.meta.get_docfield(this.df.options,e),s=$(this.wrapper).find(".grid-add-multiple-rows");s.removeClass("hidden"),s.on("click",()=>(new frappe.ui.form.LinkSelector({doctype:i.options,fieldname:e,qty_fieldname:t,target:this,txt:""}),this.grid_pagination.go_to_last_page_to_add_row(),!1)),this.multiple_set=!0}}setup_allow_bulk_edit(){let e=this;if(this.frm&&this.frm.get_docfield(this.df.fieldname).allow_bulk_edit){this.setup_download();let t={Date:i=>i&&frappe.datetime.user_to_str(i),Int:i=>cint(i),Check:i=>cint(i),Float:i=>flt(i)};frappe.flags.no_socketio=!0,$(this.wrapper).find(".grid-upload").removeClass("hidden").on("click",()=>(new frappe.ui.FileUploader({as_dataurl:!0,allow_multiple:!1,on_success(i){var s=frappe.utils.csv_to_array(frappe.utils.get_decoded_string(i.dataurl)),r=s[2];e.frm.clear_table(e.df.fieldname),$.each(s,(a,d)=>{if(a>6){var o=!0;if($.each(d,function(n,h){if(h)return o=!1,!1}),!o){var l=e.frm.add_child(e.df.fieldname);$.each(d,(n,h)=>{var p=r[n],_=frappe.meta.get_docfield(e.df.options,p);_&&(l[r[n]]=t[_.fieldtype]?t[_.fieldtype](h):h)})}}}),e.frm.refresh_field(e.df.fieldname),frappe.msgprint({message:__("Table updated"),title:__("Success"),indicator:"green"})}}),!1))}}setup_download(){let e=this.df.label||frappe.model.unscrub(this.df.fieldname);$(this.wrapper).find(".grid-download").removeClass("hidden").on("click",()=>{var t=[],i=[];return t.push([__("Bulk Edit {0}",[e])]),t.push([]),t.push([]),t.push([]),t.push([__("The CSV format is case sensitive")]),t.push([__("Do not edit headers which are preset in the template")]),t.push(["------"]),$.each(frappe.get_meta(this.df.options).fields,(s,r)=>{if(frappe.model.is_value_type(r.fieldtype)){t[1].push(r.label),t[2].push(r.fieldname);let a=(r.description||"")+" ";r.fieldtype==="Date"&&(a+=frappe.boot.sysdefaults.date_format),t[3].push(a),i.push(r)}}),$.each(this.frm.doc[this.df.fieldname]||[],(s,r)=>{var a=[];$.each(t[2],(d,o)=>{var l=r[o];i[d].fieldtype==="Date"&&l&&(l=frappe.datetime.str_to_user(l)),a.push(l||"")}),t.push(a)}),frappe.tools.downloadify(t,null,e),!1})}add_custom_button(e,t,i="bottom"){let s=i==="top"?this.grid_custom_buttons:this.grid_buttons,r=this.custom_buttons[e];return r?r.removeClass("hidden"):(r=$(`<button class="btn btn-default btn-xs btn-custom">${__(e)}</button>`).prependTo(s).on("click",t),this.custom_buttons[e]=r),r}clear_custom_buttons(){this.grid_buttons.find(".btn-custom").addClass("hidden")}update_docfield_property(e,t,i){if(!!this.grid_rows){for(let s of this.grid_rows){let r=s.docfields.find(a=>a.fieldname===e);if(r)r[t]=i;else throw`field ${e} not found`}this.docfields.find(s=>s.fieldname===e)[t]=i,this.debounced_refresh()}}};})();
//# sourceMappingURL=validation_desk.bundle.6DKPMOLQ.js.map
